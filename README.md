# ä¸€ç§è‡ªé€‚åº”çš„ç›˜å¤å¤§æ¨¡å‹ä¼˜åŒ–æ–¹æ³•

æœ¬ä»“åº“æä¾›äº†ä¸€å¥—é’ˆå¯¹ **Pangu-Embedded** ç³»åˆ—å¤§æ¨¡å‹ï¼ˆ1B/7Bï¼‰åœ¨ **åä¸ºæ˜‡è…¾ (Ascend) NPU** å¹³å°ä¸Šçš„å…¨æ ˆä¼˜åŒ–æ–¹æ¡ˆã€‚æ¶µç›–äº†ä»æƒé‡å‹ç¼©ï¼ˆW8A16 é‡åŒ–ï¼‰ã€ç»“æ„åŒ–å‰ªæï¼ˆTaylor è¿­ä»£å‰ªæ + è’¸é¦ï¼‰åˆ°æŠ•æœºæ¨ç†ï¼ˆdraftã€PLDï¼‰ä»¥åŠè‡ªé€‚åº”æ„å›¾è¯†åˆ«æ¡†æ¶ã€‚

---

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

- **W8A16 æ··åˆç²¾åº¦é‡åŒ–**ï¼šInt8 æƒé‡å­˜å‚¨ï¼ŒBF16 è¿è¡Œæ—¶åé‡åŒ–è®¡ç®—ï¼Œæ˜¾å­˜å ç”¨é™ä½ ~38%ã€‚
- **åŸºäº Taylor çš„è¿­ä»£å‰ªæ**ï¼šé‡‡ç”¨ä¸€é˜¶æ¢¯åº¦é‡è¦æ€§è¯„åˆ†ï¼Œç»“åˆ 256-bit NPU ç¡¬ä»¶å¯¹é½ï¼Œç¡®ä¿ç‰©ç†åŠ é€Ÿã€‚
- **çŸ¥è¯†è’¸é¦**ï¼šé€šè¿‡ KL æ•£åº¦ï¼Œåœ¨é«˜å‰ªæç‡ä¸‹æ¢å¤ç²¾åº¦ã€‚
- **åŒæ¨¡æŠ•æœºæ¨ç†åŠ é€Ÿ**ï¼š
  - **Draft Model æ–¹æ¡ˆ**ï¼š7B ä¸»æ¨¡å‹ + 1B è‰ç¨¿æ¨¡å‹ååŒï¼Œæå‡é€»è¾‘ä¸€è‡´æ€§ã€‚
  - **PLD (Pattern Lookahead Decoding)**ï¼šåŸºäº N å…ƒåŒ¹é…çš„é›¶è€—æ—¶è‰ç¨¿ç”Ÿæˆï¼Œæœ€é«˜å®ç° 2 å€é€Ÿåº¦æå‡ã€‚
- **è‡ªé€‚åº”ä¼˜åŒ–æ¡†æ¶**ï¼šåˆ©ç”¨ 1B æ¨¡å‹è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼Œæ™ºèƒ½æ¨èæœ€åŒ¹é…çš„æ¨ç†ç­–ç•¥ã€‚

---

## ğŸ›  æŠ€æœ¯æ–¹æ¡ˆè¯¦è§£

### 1. W8A16 æ··åˆç²¾åº¦é‡åŒ–
å®ç°äº†ä¸€ç§â€œä½åŠŸè€—å­˜å‚¨ï¼Œé«˜ç²¾åº¦è®¡ç®—â€çš„é‡åŒ–æ–¹æ¡ˆã€‚
é’ˆå¯¹çº¿æ€§å±‚æƒé‡è¿›è¡Œ Int8 é‡åŒ–ã€‚åœ¨å‰å‘ä¼ æ’­æ—¶ï¼Œå®æ—¶å°†æƒé‡è¿˜åŸä¸º BF16 ä¸æ¿€æ´»å€¼è¿›è¡ŒçŸ©é˜µä¹˜æ³•ã€‚
- **ç®—æ³•é€»è¾‘**ï¼šè®¡ç®—æ¯é€šé“ç¼©æ”¾å› å­ $Scale = \frac{\max(|W|)}{127}$ï¼Œå°†æƒé‡æ˜ å°„è‡³ $[-128, 127]$ã€‚
- **æ˜¾å­˜æ”¶ç›Š**ï¼šPangu-1B æ˜¾å­˜å ç”¨ä» **2.15GB** é™è‡³ **1.34GB**ã€‚

### 2. è¿­ä»£å¼ Taylor å‰ªæä¸å¤šç»´è’¸é¦
é’ˆå¯¹ MLP ç»´åº¦è¿›è¡Œç»“æ„åŒ–ç§»é™¤ï¼Œé€šè¿‡ 5 è½®çº¿æ€§è°ƒåº¦å¹³æ»‘å‹ç¼©ç©ºé—´ã€‚
- **Taylor è¯„åˆ†**ï¼š$Score = |W \cdot \nabla W|$ï¼Œç²¾å‡†è¯†åˆ«å¯¹æŸå¤±å‡½æ•°æ³¢åŠ¨è´¡çŒ®æœ€å°çš„ç¥ç»å…ƒã€‚
- **NPU å¯¹é½**ï¼šå¼ºåˆ¶ä¿ç•™ç»´åº¦ä¸º 256 çš„å€æ•°ï¼Œæ¶ˆé™¤ç‰©ç†å±‚é¢çš„ç¡¬ä»¶ Paddingï¼Œæå‡ç®—åŠ›åˆ©ç”¨ç‡ã€‚
- **æœ€ä¼˜é…ç½®**ï¼š5e-5 å­¦ä¹ ç‡ + çº¿æ€§è°ƒåº¦ + KL è’¸é¦ã€‚

### 3. æŠ•æœºæ¨ç†åŠ é€Ÿ 
é’ˆå¯¹è‡ªå›å½’ç”Ÿæˆçš„ä¸²è¡Œç“¶é¢ˆï¼Œæä¾›äº†ä¸¤ç±»åŠ é€Ÿæ–¹æ¡ˆï¼š
- **è‰ç¨¿æ¨¡å‹æ–¹æ¡ˆ**ï¼šä½¿ç”¨ 1B æ¨¡å‹ä½œä¸ºè‰ç¨¿æ¨¡å‹ï¼ˆDraftï¼‰é¢„ç”ŸæˆKä¸ª Tokenï¼Œ7B ä¸»æ¨¡å‹è¿›è¡Œå¹¶è¡ŒéªŒè¯ï¼Œæ˜¾è‘—æå‡ååé‡ã€‚
- **PLD æ–¹æ¡ˆ**ï¼šåŸºäº N-Gram åŒ¹é…çš„é¢„æµ‹æŸ¥æ‰¾è§£ç ã€‚åˆ©ç”¨Â NGramMatcherÂ åœ¨å†å²ä¸Šä¸‹æ–‡ä¸­æ£€ç´¢é‡å¤æ¨¡å¼ï¼Œå®ç°é›¶å‚æ•°æ¶ˆè€—çš„è‰ç¨¿ç”Ÿæˆã€‚

### 4.è‡ªé€‚åº”ä¼˜åŒ–æ¡†æ¶
é›†æˆæ„å›¾è¯†åˆ«é€»è¾‘ï¼Œåˆ©ç”¨ 1B æ¨¡å‹è‡ªåŠ¨åˆ¤æ–­ç”¨æˆ·ä»»åŠ¡ç±»å‹ï¼Œå¹¶æ ¹æ®å®éªŒåŸºå‡†ï¼ˆBenchmarkï¼‰è‡ªåŠ¨æ¨èæœ€ä¼˜çš„é‡åŒ–/å‰ªæ/åŠ é€Ÿç»„åˆç­–ç•¥ã€‚

---

## ğŸ“Š å®éªŒç»“æœ

### å‰ªæä¸è’¸é¦æ€§èƒ½ (GSM8K å‡†ç¡®ç‡)

| MLPå±‚å‰ªæç‡ | GSM8Kè¯„åˆ† |
| ------- | ------- |
| 4.17%   | 71.87   |
| 8.33    | 69.52   |
| 12.5    | 64.59   |
| 16.67   | 61.87   |
| 20.83   | 61.87   |
### æŠ•æœºæ¨ç†åŠ é€Ÿæ¯” (Tokens/s)
ä»¥ Pangu-1B ä¸ºä¾‹ï¼Œé‡‡ç”¨ PLD æ–¹æ¡ˆï¼ˆN=3, K=4ï¼‰ï¼š

| æ¨¡å‹       |  è¯„æµ‹ä»»åŠ¡  | Baseline é€Ÿåº¦ | PLD é€Ÿåº¦ |    åŠ é€Ÿæ¯”    |
| :------- | :----: | :---------: | :----: | :-------: |
| Pangu-1B | C-Eval |    21.58    | 41.93  | **1.94x** |
| Pangu-1B |  MMLU  |    21.87    | 43.41  | **1.98x** |

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

- src/iterative_pruning.py: æ ¸å¿ƒå‰ªæä¸å¤šç»´è’¸é¦å®ç°ã€‚
    
- src/quantization.py: W8A16 é‡åŒ–å™¨ä¸åé‡åŒ–çº¿æ€§å±‚å®šä¹‰ã€‚
    
- src/speculative_decoder.py: åŸºäº Top-K é‡‡æ ·çš„å¤§-å°æ¨¡å‹æŠ•æœºè§£ç å™¨ã€‚
    
- src/pld_model.py: åŸºäº N-Gram åŒ¹é…çš„é¢„æµ‹æŸ¥æ‰¾è§£ç å®ç°ï¼ˆé€‚é… OpenCompassï¼‰ã€‚
    
- docs/: è¯¦ç»†çš„å®éªŒæŠ¥å‘Šä¸æŠ€æœ¯åˆ†ææ–‡æ¡£ã€‚

---

## âš™ï¸ ç¯å¢ƒè¦æ±‚

- **Hardware**: Huawei Ascend 910B/310P NPU
- **Framework**: `torch >= 2.1.0`, `torch_npu`, `transformers >= 4.34.0`
- **CANN**: åä¸ºæ˜‡è…¾ CANN ç¤¾åŒºç‰ˆ/å•†ä¸šç‰ˆ

---

## ğŸ“– å¿«é€Ÿå¼€å§‹

### 1. æ··åˆç²¾åº¦é‡åŒ–
```bash
python quantization/quantize.py --model_path ./pangu_1b --save_path ./pangu_1b_w8a16
```

### 2. è¿­ä»£å‰ªæä¸è’¸é¦
```bash
python pruning_distillation/main.py --iterative_steps 5 --target_sparsity 0.2 --enable_distill True
```

### 3. è‡ªé€‚åº”æŠ•æœºæ¨ç†
```bash
python adaptive_framework/run_inference.py --input "è¯·å¸®æˆ‘å†™ä¸€æ®µå…³äºé‡å­è®¡ç®—çš„ç§‘æ™®æ–‡å­—"
```

---

## ğŸ“œ å¼•ç”¨ä¸è‡´è°¢
æœ¬é¡¹ç ”ç©¶åŸºäºç›˜å¤å¤§æ¨¡å‹ç³»åˆ—ã€‚æ„Ÿè°¢åä¸ºæ˜‡è…¾æä¾›çš„è®¡ç®—èµ„æºä¸ `torch_npu` æŠ€æœ¯æ”¯æŒã€‚

--- 

**é¡¹ç›®ç»´æŠ¤è€…**ï¼š[æ¹–å—å¤§å­¦æ™ºèƒ½è®¡ç®—ç³»ç»Ÿç ”ç©¶æ‰€ï¼ˆIICSï¼‰]
**è”ç³»æ–¹å¼**ï¼š[ding@hnu.edu.cn]
